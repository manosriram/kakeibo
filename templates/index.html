<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kakeibo - Terminal</title>
    <link rel="stylesheet" href="https://unpkg.com/terminal.css@0.7.2/dist/terminal.min.css" />
    <style>
        :root {
            --global-font-size: 15px;
            --global-line-height: 1.4;
        }
        body { padding: 20px; }
        .compact-stats {
            display: flex;
            justify-content: space-between;
            border: 1px dashed #666;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        /* Fixed hover visibility */
        .txn-row:hover { 
            background-color: var(--secondary-color) !important; 
        }
        /* Specifically force white text for all cells (including date) on hover */
        .txn-row:hover td, 
        .txn-row:hover td span { 
            color: #ffffff !important; 
        }

        .amount-credit { color: #2ecc71; font-weight: bold; }
        .amount-debit { color: #e74c3c; font-weight: bold; }
        .tag-badge { 
            border: 1px solid currentColor; 
            padding: 0 4px; 
            font-size: 0.8em; 
            text-transform: uppercase;
        }
        td, th { padding: 8px 10px !important; }
        #statusMessage { margin-left: 10px; font-weight: bold; }
        
        .filter-container {
            display: flex;
            gap: 15px;
            align-items: center;
        }
    </style>
</head>
<body class="terminal">
    <div class="container">
        <div class="terminal-nav">
            <header class="terminal-logo">
                <div class="logo terminal-prompt"><a href="#">KAKEIBO_V1.0</a></div>
            </header>
            <nav class="terminal-menu">
                <span id="statusMessage"></span>
            </nav>
        </div>

        <section>
            <form id="kakeiboForm">
                <fieldset>
                    <legend>Quick Add Entry</legend>
                    <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex-grow: 1;">
                            <label for="naturalInput">Input Command:</label>
                            <input id="naturalInput" type="text" placeholder="Coffee 5.50 Food" required autocomplete="off">
                        </div>
                        <button class="btn btn-primary" type="submit" id="btnText">EXECUTE</button>
                    </div>
                </fieldset>
            </form>
        </section>

        <div class="compact-stats">
            <div>INCOME: <span class="amount-credit">{{ .credit }}</span></div>
            <div>EXPENSES: <span class="amount-debit">{{ .debit }}</span></div>
            <div>SAVINGS: <span>{{ .savings }} ({{.savingsPercentage}}%)</span></div>
        </div>

        <section>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0;">TRANSACTION_LOG</h3>
                <div class="filter-container">
                    <div class="form-group" style="margin: 0;">
                        <select id="timeFilter">
                            <option value="all">ALL_TIME</option>
                            <option value="1">THIS_MONTH</option>
                            <option value="3">LAST_3_MONTHS</option>
                            <option value="6">LAST_6_MONTHS</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <select id="categoryFilter">
                            <option value="">ALL_CATEGORIES</option>
                            <option value="FOOD">FOOD</option>
                            <option value="TRANSPORT">TRANSPORT</option>
                            <option value="SHOPPING">SHOPPING</option>
                            <option value="UTILITIES">UTILITIES</option>
                            <option value="INCOME">INCOME</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                    </div>
                </div>
            </div>

            <table class="terminal-table">
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>CATEGORY</th>
                        <th>DESCRIPTION</th>
                        <th class="text-right">AMOUNT</th>
                    </tr>
                </thead>
                <tbody id="transactionBody">
                    {{ if .statements }}
                        {{ range .statements }}
                    <tr class="txn-row" data-date="{{ .CreatedAt.Time.Format "2006-01-02T15:04:05Z07:00" }}">
                        <td style="white-space: nowrap;">{{ formatDate .CreatedAt.Time }}</td>
                        <td><span class="tag-badge">{{ .Tag.String }}</span></td>
                        <td>{{ .Description.String }}</td>
                        <td class="text-right {{ if eq .TxnType.String "credit" }}amount-credit{{ else }}amount-debit{{ end }}">
                            {{ if eq .TxnType.String "credit" }}+{{ else }}-{{ end }}â‚¹{{ .Amount.Int64 }}
                        </td>
                    </tr>
                        {{ end }}
                    {{ else }}
                    <tr>
                        <td colspan="4" style="text-align: center;">NO_DATA_AVAILABLE</td>
                    </tr>
                    {{ end }}
                </tbody>
            </table>
        </section>

        <div style="display: flex; justify-content: space-between; margin-top: 20px;">
            <div class="btn-group">
                <button class="btn btn-default btn-ghost" id="prevBtn">PREV</button>
                <button class="btn btn-default btn-ghost" id="nextBtn" {{ if not .hasNextPage }}disabled{{ end }}>NEXT</button>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('kakeiboForm');
        const statusMsg = document.getElementById('statusMessage');
        const categoryFilter = document.getElementById('categoryFilter');
        const timeFilter = document.getElementById('timeFilter');
        const rows = document.querySelectorAll('#transactionBody tr.txn-row');

        // Combined Filter Function
        function applyFilters() {
            const catValue = categoryFilter.value.toLowerCase();
            const timeValue = timeFilter.value;
            const now = new Date();

            rows.forEach(row => {
                const rowDate = new Date(row.getAttribute('data-date'));
                const rowCat = row.querySelector('.tag-badge')?.textContent.toLowerCase() || "";
                
                // Category Check
                const matchesCat = !catValue || rowCat.includes(catValue);
                
                // Time Check
                let matchesTime = true;
                if (timeValue !== 'all') {
                    const monthsAgo = new Date();
                    monthsAgo.setMonth(now.getMonth() - parseInt(timeValue));
                    
                    if (timeValue === "1") {
                        // "This Month" logic: must be same month and year
                        matchesTime = (rowDate.getMonth() === now.getMonth() && rowDate.getFullYear() === now.getFullYear());
                    } else {
                        // "Last X Months" logic: date must be after the calculated threshold
                        matchesTime = (rowDate >= monthsAgo);
                    }
                }

                row.style.display = (matchesCat && matchesTime) ? '' : 'none';
            });
        }

        categoryFilter.addEventListener('change', applyFilters);
        timeFilter.addEventListener('change', applyFilters);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const rawValue = document.getElementById('naturalInput').value;
            const btn = document.getElementById('btnText');
            btn.innerText = 'WAIT...';

            try {
                const response = await fetch('/api/transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description: rawValue })
                });

                if (response.ok) {
                    statusMsg.innerText = '[SUCCESS]';
                    statusMsg.style.color = '#2ecc71';
                    form.reset();
                    setTimeout(() => location.reload(), 600);
                } else { throw new Error(); }
            } catch (err) {
                statusMsg.innerText = '[ERROR]';
                statusMsg.style.color = '#e74c3c';
            } finally {
                btn.innerText = 'EXECUTE';
            }
        });

        document.getElementById('prevBtn').addEventListener('click', () => window.location.href = "/?page={{.prev}}");
        document.getElementById('nextBtn').addEventListener('click', () => window.location.href = "/?page={{.next}}");
    </script>
</body>
</html>
